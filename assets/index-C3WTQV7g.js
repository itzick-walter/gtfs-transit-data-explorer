(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function o(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=o(i);fetch(i.href,s)}})();class Ee{constructor(){this.feeds=new Map,this.nextFeedId=1}addFeed(t,o,n={}){const i=this.nextFeedId++,s={id:i,name:t,importedAt:new Date,metadata:n,agencies:new Map(Object.entries(o.agencies)),routes:new Map(Object.entries(o.routes)),trips:new Map(Object.entries(o.trips)),stops:new Map(Object.entries(o.stops)),shapes:new Map(Object.entries(o.shapes)),tripsByRoute:new Map(Object.entries(o.tripsByRoute).map(([r,c])=>[r,new Set(c)])),tripsByService:new Map(Object.entries(o.tripsByService).map(([r,c])=>[r,new Set(c)])),stopsByRoute:new Map(Object.entries(o.stopsByRoute).map(([r,c])=>[r,new Set(c)])),stopTimesByTrip:new Map(Object.entries(o.stopTimesByTrip)),servicesByDate:new Map(Object.entries(o.servicesByDate).map(([r,c])=>[r,new Set(c)])),stats:o.stats};return this.feeds.set(i,s),i}removeFeed(t){return this.feeds.delete(t)}getFeed(t){return this.feeds.get(t)}getAllFeeds(){return Array.from(this.feeds.values())}getAgencies(t=null){if(t){const n=this.feeds.get(t);return n?Array.from(n.agencies.values()):[]}const o=[];for(const n of this.feeds.values())for(const i of n.agencies.values())o.push({...i,feedId:n.id,feedName:n.name});return o}getRoutes(t={}){const{feedId:o,agencyIds:n,routeTypes:i,date:s}=t;let r=[];const c=o?[this.feeds.get(o)]:Array.from(this.feeds.values());for(const a of c){if(!a)continue;let l=null;if(!(s&&(l=a.servicesByDate.get(s),!l||l.size===0))){for(const d of a.routes.values())if(!(n&&n.length>0&&d.agency_id&&!n.includes(d.agency_id))&&!(i&&i.length>0&&!i.includes(d.route_type))){if(l){const u=a.tripsByRoute.get(d.route_id);if(!u)continue;let g=!1;for(const p of u){const m=a.trips.get(p);if(m&&l.has(m.service_id)){g=!0;break}}if(!g)continue}r.push({...d,feedId:a.id,feedName:a.name})}}}return r}getStops(t={}){const{feedId:o,routeId:n,date:i,polygons:s}=t;let r=[];const c=o?[this.feeds.get(o)]:Array.from(this.feeds.values());for(const a of c){if(!a)continue;let l=null;if(n&&(l=a.stopsByRoute.get(n),!l))continue;if(i&&!n){const u=a.servicesByDate.get(i);if(!u||u.size===0)continue;l=new Set;for(const g of u){const p=a.tripsByService.get(g);if(p)for(const m of p){const h=a.stopTimesByTrip.get(m);if(h)for(const _ of h)l.add(_.stop_id)}}}const d=l?Array.from(l).map(u=>a.stops.get(u)).filter(Boolean):Array.from(a.stops.values());for(const u of d){if(s&&s.length>0){const g=[u.stop_lon,u.stop_lat];let p=!1;for(const m of s)if(this.isPointInPolygon(g,m)){p=!0;break}if(!p)continue}r.push({...u,feedId:a.id,feedName:a.name})}}return r}getRouteDetails(t,o,n=null){const i=this.feeds.get(t);if(!i)return null;const s=i.routes.get(o);if(!s)return null;const r=i.tripsByRoute.get(o);if(!r)return{...s,variants:[]};let c=null;if(n&&(c=i.servicesByDate.get(n),!c||c.size===0))return{...s,variants:[]};const a=new Map;for(const d of r){const u=i.trips.get(d);if(!u||c&&!c.has(u.service_id))continue;const g=`${u.direction_id}_${u.shape_id||"none"}`;a.has(g)||a.set(g,{direction_id:u.direction_id,shape_id:u.shape_id,trip_count:0,sample_trip_id:d,headsign:u.trip_headsign}),a.get(g).trip_count++}const l=Array.from(a.values()).sort((d,u)=>u.trip_count-d.trip_count);for(const d of l){if(d.shape_id){const g=i.shapes.get(d.shape_id);g&&(d.coordinates=g)}const u=new Set;for(const g of r){const p=i.trips.get(g);if(p&&p.direction_id===d.direction_id&&p.shape_id===d.shape_id){const m=i.stopTimesByTrip.get(g);if(m)for(const h of m)u.add(h.stop_id)}}d.stops=Array.from(u).map(g=>i.stops.get(g)).filter(Boolean)}return{...s,feedId:t,feedName:i.name,variants:l}}getAvailableDates(t=null){const o=new Set,n=t?[this.feeds.get(t)]:Array.from(this.feeds.values());for(const i of n)if(i)for(const s of i.servicesByDate.keys())o.add(s);return Array.from(o).sort()}isPointInPolygon(t,o){const[n,i]=t;let s;if(o.type==="Feature")s=o.geometry.coordinates;else if(o.type==="Polygon")s=o.coordinates;else if(o.type==="MultiPolygon"){for(const r of o.coordinates)if(this.pointInRing(t,r[0]))return!0;return!1}else return!1;return this.pointInRing(t,s[0])}pointInRing(t,o){const[n,i]=t;let s=!1;for(let r=0,c=o.length-1;r<o.length;c=r++){const[a,l]=o[r],[d,u]=o[c];l>i!=u>i&&n<(d-a)*(i-l)/(u-l)+a&&(s=!s)}return s}clear(){this.feeds.clear(),this.nextFeedId=1}}const v=new Ee,Ie="1.0.0",ye=1;function Le(e,t,o,n,i){var c,a,l;const s=t.getCenter(),r=t.getZoom();return{version:Ie,schemaVersion:ye,projectName:e||"Untitled Project",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),mapState:{center:{lat:s.lat,lng:s.lng},zoom:r},polygons:o.map(d=>{var u,g,p;return{id:d.id||`poly_${Date.now()}_${Math.random()}`,name:((u=d.properties)==null?void 0:u.name)||d.name||"Unnamed Polygon",visible:d.visible!==!1,geojson:{type:"Feature",geometry:d.geometry,properties:{name:((g=d.properties)==null?void 0:g.name)||d.name||"Unnamed Polygon",description:((p=d.properties)==null?void 0:p.description)||""}}}}),feeds:n.map(d=>{var u,g,p;return{name:d.name,sourceType:((u=d.metadata)==null?void 0:u.sourceType)||"file",sourceUrl:((g=d.metadata)==null?void 0:g.sourceUrl)||null,notes:((p=d.metadata)==null?void 0:p.notes)||"",imported:!1}}),filters:{selectedDate:i.selectedDate||null,calendarMode:i.calendarMode||"all",selectedFeedId:i.selectedFeedId||null,visibleAgencyIds:i.visibleAgencyIds||[],routeTypes:i.routeTypes||[],selectedRouteId:i.selectedRouteId||null,selectedVariantIndex:i.selectedVariantIndex||0,stopFilters:{insidePolygonsOnly:((c=i.stopFilters)==null?void 0:c.insidePolygonsOnly)||!1,accessibleOnly:((a=i.stopFilters)==null?void 0:a.accessibleOnly)||!1,orphansOnly:((l=i.stopFilters)==null?void 0:l.orphansOnly)||!1}}}}function ke(e){if(e.schemaVersion>ye)throw new Error(`Project file is from a newer version (schema ${e.schemaVersion}). Please update the app.`);return{projectName:e.projectName||"Untitled Project",createdAt:e.createdAt,updatedAt:e.updatedAt,mapState:e.mapState||{center:{lat:0,lng:0},zoom:2},polygons:(e.polygons||[]).map(t=>({id:t.id,name:t.name,visible:t.visible!==!1,geometry:t.geojson.geometry,properties:t.geojson.properties})),feeds:e.feeds||[],filters:e.filters||{}}}async function Se(e,t){const o=JSON.stringify(e,null,2),n=new Blob([o],{type:"application/json"});if("showSaveFilePicker"in window)try{const c=await(await window.showSaveFilePicker({suggestedName:t,types:[{description:"Transit Data Explorer Project",accept:{"application/json":[".tde"]}}]})).createWritable();return await c.write(n),await c.close(),{success:!0,method:"file-system-access"}}catch(r){if(r.name==="AbortError")return{success:!1,cancelled:!0};console.warn("File System Access API failed, falling back to download:",r)}const i=URL.createObjectURL(n),s=document.createElement("a");return s.href=i,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),{success:!0,method:"download"}}async function Fe(e){const t=await e.text(),o=JSON.parse(t);if(!o.version||!o.projectName)throw new Error("Invalid project file: missing required fields");return ke(o)}const q="1.1.1",ge={0:{name:"Tram/Light Rail",color:"#F4C430"},1:{name:"Subway/Metro",color:"#0057B8"},2:{name:"Rail",color:"#8B1E3F"},3:{name:"Bus",color:"#2E8B57"},4:{name:"Ferry",color:"#008080"},5:{name:"Cable Tram",color:"#E67E22"},6:{name:"Gondola",color:"#6A5ACD"},7:{name:"Funicular",color:"#8B5A2B"},default:{name:"Unknown",color:"#3498db"}};function R(e){return ge[e]||ge.default}function _e(e){const t={0:`<g fill="white">
            <line x1="7" y1="3" x2="17" y2="3" stroke="white" stroke-width="2.5"/>
            <line x1="12" y1="3" x2="12" y2="6" stroke="white" stroke-width="2"/>
            <rect x="5" y="6" width="14" height="12" rx="2"/>
            <rect x="6.5" y="7.5" width="11" height="6" rx="1" fill="#F4C430"/>
            <circle cx="8" cy="19" r="2.5"/>
            <circle cx="16" cy="19" r="2.5"/>
        </g>`,1:`<g fill="white">
            <rect x="5" y="6" width="14" height="13" rx="3"/>
            <rect x="6.5" y="7.5" width="11" height="6" rx="1" fill="#0057B8"/>
            <text x="12" y="17" font-size="8" font-weight="bold" text-anchor="middle" fill="white">M</text>
            <circle cx="9" cy="20" r="2.5"/>
            <circle cx="15" cy="20" r="2.5"/>
        </g>`,2:`<g fill="white">
            <rect x="2" y="7" width="20" height="11" rx="2"/>
            <rect x="4" y="9" width="16" height="6" rx="1" fill="#8B1E3F"/>
            <circle cx="6" cy="19" r="2.5"/>
            <circle cx="12" cy="19" r="2.5"/>
            <circle cx="18" cy="19" r="2.5"/>
        </g>`,3:`<g fill="white">
            <rect x="3" y="5" width="18" height="16" rx="2.5"/>
            <rect x="4.5" y="6.5" width="15" height="6" rx="1" fill="#2E8B57"/>
            <circle cx="7" cy="16" r="2"/>
            <circle cx="17" cy="16" r="2"/>
            <rect x="5" y="19" width="14" height="2" rx="1"/>
            <circle cx="7" cy="22" r="2.5"/>
            <circle cx="17" cy="22" r="2.5"/>
        </g>`,4:`<g fill="white">
            <rect x="7" y="5" width="10" height="7" rx="1"/>
            <rect x="8.5" y="6.5" width="7" height="4" rx="0.5" fill="#008080"/>
            <path d="M4 13 L7 13 L7 16 L12 18 L17 16 L17 13 L20 13 L18 17 L6 17 Z"/>
            <rect x="10.5" y="3" width="3" height="2" rx="0.5"/>
        </g>`,5:`<g fill="white">
            <line x1="1" y1="4" x2="23" y2="4" stroke="white" stroke-width="3"/>
            <line x1="12" y1="4" x2="12" y2="8" stroke="white" stroke-width="2.5"/>
            <rect x="6" y="8" width="12" height="10" rx="2"/>
            <rect x="7.5" y="9.5" width="9" height="6" rx="1" fill="#E67E22"/>
            <circle cx="9" cy="19" r="2"/>
            <circle cx="15" cy="19" r="2"/>
        </g>`,6:`<g fill="white">
            <line x1="1" y1="4" x2="23" y2="4" stroke="white" stroke-width="3"/>
            <line x1="8" y1="4" x2="8" y2="8" stroke="white" stroke-width="2.5"/>
            <line x1="16" y1="4" x2="16" y2="8" stroke="white" stroke-width="2.5"/>
            <rect x="6" y="8" width="12" height="11" rx="3"/>
            <rect x="7.5" y="9.5" width="9" height="7" rx="1" fill="#6A5ACD"/>
            <line x1="6" y1="19" x2="3" y2="21" stroke="white" stroke-width="2.5"/>
            <line x1="18" y1="19" x2="21" y2="21" stroke="white" stroke-width="2.5"/>
        </g>`,7:`<g fill="white">
            <rect x="4" y="5" width="16" height="12" rx="2" transform="rotate(-20 12 12)"/>
            <rect x="6" y="7" width="12" height="7" rx="1" fill="#8B5A2B" transform="rotate(-20 12 12)"/>
            <circle cx="6" cy="17" r="2.5"/>
            <circle cx="18" cy="17" r="2.5"/>
            <line x1="2" y1="19" x2="22" y2="12" stroke="white" stroke-width="3.5"/>
        </g>`,default:'<g fill="white"><circle cx="12" cy="12" r="5"/></g>'};return t[e]||t.default}function Te(e,t=28){const o=R(e),n=_e(e),i=`
        <div style="width:${t}px;height:${t}px;background-color:${o.color};border:2px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.4);">
            <svg width="${t*.65}" height="${t*.65}" viewBox="0 0 24 24" fill="none">${n}</svg>
        </div>`;return L.divIcon({html:i,className:"custom-stop-icon",iconSize:[t,t],iconAnchor:[t/2,t/2],popupAnchor:[0,-t/2]})}const pe=["#E53935","#1E88E5","#43A047","#FB8C00","#8E24AA","#00ACC1","#FFB300","#D81B60","#00897B","#6D4C41","#546E7A","#C0CA33","#F4511E","#7B1FA2","#0277BD","#2E7D32","#AD1457","#5E35B1","#00695C","#EF6C00"],W=new Map;function Ae(e,t){if(W.has(e.route_id))return W.get(e.route_id);if(e.route_color&&e.route_color.length===6){const i="#"+e.route_color;return W.set(e.route_id,i),i}R(e.route_type).color;const o=t.findIndex(i=>i.route_id===e.route_id),n=pe[o%pe.length];return W.set(e.route_id,n),n}const me='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',he='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';let f,T,G,F=[],I=[],E=new Set,k=new Set,S=new Set,w=null,b={projectName:"Untitled Project",isDirty:!1,savedFilePath:null,createdAt:null};window.addEventListener("DOMContentLoaded",()=>{console.log("Transit Data Explorer v"+q+" - Static Frontend");const e=document.getElementById("dockVersion"),t=document.getElementById("aboutVersion"),o=document.getElementById("versionPill");e&&(e.textContent="v"+q),t&&(t.textContent="v"+q),o&&(o.textContent="v"+q),Be(),Pe(),z(),w=ne(new Date)});function Be(){f=L.map("map",{dragging:!0,touchZoom:!0,scrollWheelZoom:!0,doubleClickZoom:!0,boxZoom:!0,keyboard:!0,zoomControl:!0}).setView([40.7128,-74.006],10),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors",maxZoom:19}).addTo(f),T=L.markerClusterGroup({disableClusteringAtZoom:16,spiderfyOnMaxZoom:!0,showCoverageOnHover:!1,zoomToBoundsOnClick:!0,maxClusterRadius:50,bubblingMouseEvents:!0}),f.addLayer(T),G=L.layerGroup().addTo(f),console.log("[Map] Initialized with dragging enabled and stop clustering")}function Pe(){var o,n,i,s,r,c,a,l,d,u,g,p,m,h,_,N,O,P,C,Z,D,K,ie,se,re,le,ce,ae,de,ue;const e=x=>document.getElementById(x);(o=e("tabData"))==null||o.addEventListener("click",()=>X("data")),(n=e("tabLayers"))==null||n.addEventListener("click",()=>X("layers")),(i=e("tabFilters"))==null||i.addEventListener("click",()=>X("filters"));const t=e("collapseStrip");t&&(t.addEventListener("click",fe),t.addEventListener("keydown",x=>{x.key==="Enter"&&fe()})),(s=e("btnImportFeed"))==null||s.addEventListener("click",Ce),(r=e("btnAddPolygon"))==null||r.addEventListener("click",Me),(c=e("btnResetDb"))==null||c.addEventListener("click",qe),(a=e("btnCloseFeedModal"))==null||a.addEventListener("click",te),(l=e("feedTabUrl"))==null||l.addEventListener("click",()=>ee("url")),(d=e("feedTabFile"))==null||d.addEventListener("click",()=>ee("file")),(u=e("btnSubmitFeedUrl"))==null||u.addEventListener("click",Oe),(g=e("btnSubmitFeedFile"))==null||g.addEventListener("click",De),(p=e("btnClosePolygonModal"))==null||p.addEventListener("click",ve),(m=e("btnSubmitPolygon"))==null||m.addEventListener("click",$e),(h=e("btnCloseAboutModal"))==null||h.addEventListener("click",je),(_=e("burgerMenuTrigger"))==null||_.addEventListener("click",x=>{var A;x.stopPropagation(),(A=e("burgerMenuDropdown"))==null||A.classList.toggle("open")}),(N=e("menuNewProject"))==null||N.addEventListener("click",()=>{M(),tt()}),(O=e("menuSaveProject"))==null||O.addEventListener("click",()=>{M(),xe()}),(P=e("menuSaveAs"))==null||P.addEventListener("click",()=>{M(),ot()}),(C=e("menuLoadProject"))==null||C.addEventListener("click",()=>{var x;M(),(x=e("projectFileInput"))==null||x.click()}),(Z=e("menuToggleTheme"))==null||Z.addEventListener("click",()=>{M(),Ne()}),(D=e("menuAbout"))==null||D.addEventListener("click",()=>{M(),Re()}),(K=e("projectFileInput"))==null||K.addEventListener("change",nt),(ie=e("feedFilter"))==null||ie.addEventListener("change",J),(se=e("dayTypeSelect"))==null||se.addEventListener("change",We),(re=e("btnClearFilters"))==null||re.addEventListener("click",Ke),(le=e("calTrigger"))==null||le.addEventListener("click",x=>Ye(x)),(ce=e("agencyMasterCheckbox"))==null||ce.addEventListener("change",function(){Ge(this.checked)}),(ae=e("routesMasterCheckbox"))==null||ae.addEventListener("change",function(){He(this.checked)}),(de=e("polygonsMasterCheckbox"))==null||de.addEventListener("change",function(){Je(this.checked)}),(ue=e("stopsVisibleCheckbox"))==null||ue.addEventListener("change",function(){Ze(this.checked)}),document.querySelectorAll(".modal-overlay").forEach(x=>{x.addEventListener("click",A=>{A.target===x&&(x.style.display="none")})}),document.addEventListener("click",x=>{const A=e("burgerMenuDropdown"),Q=e("burgerMenuTrigger");A!=null&&A.classList.contains("open")&&!A.contains(x.target)&&!(Q!=null&&Q.contains(x.target))&&M()})}function X(e){document.querySelectorAll(".dock-tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===e)),document.querySelectorAll(".dock-panel").forEach(t=>t.classList.toggle("active",t.id==="dock-"+e))}function fe(){const e=document.getElementById("leftDock");if(!e)return;e.classList.toggle("collapsed");const t=e.querySelector(".collapse-chevron");t&&(t.textContent=e.classList.contains("collapsed")?"▶":"◀"),setTimeout(()=>f==null?void 0:f.invalidateSize(),250)}function M(){var e;(e=document.getElementById("burgerMenuDropdown"))==null||e.classList.remove("open")}function Ce(){const e=document.getElementById("feedModal");e&&(e.style.display="flex"),ee("url")}function te(){const e=document.getElementById("feedModal");e&&(e.style.display="none")}function ee(e){var t,o,n,i;(t=document.getElementById("feedTabUrl"))==null||t.classList.toggle("active",e==="url"),(o=document.getElementById("feedTabFile"))==null||o.classList.toggle("active",e==="file"),(n=document.getElementById("feedTab-url"))==null||n.classList.toggle("active",e==="url"),(i=document.getElementById("feedTab-file"))==null||i.classList.toggle("active",e==="file")}function Me(){const e=document.getElementById("polygonModal");e&&(e.style.display="flex")}function ve(){const e=document.getElementById("polygonModal");e&&(e.style.display="none")}function Re(){const e=document.getElementById("aboutModal");e&&(e.style.display="flex")}function je(){const e=document.getElementById("aboutModal");e&&(e.style.display="none")}function Ne(){document.body.classList.toggle("dark-mode");const e=document.getElementById("themeToggleText");e&&(e.textContent=document.body.classList.contains("dark-mode")?"Light Mode":"Dark Mode")}async function Oe(){var i,s;const e=document.getElementById("gtfsName"),t=document.getElementById("gtfsUrl"),o=(i=t==null?void 0:t.value)==null?void 0:i.trim();if(!o){y("Please enter a GTFS URL","error");return}const n=((s=e==null?void 0:e.value)==null?void 0:s.trim())||new URL(o).hostname;te(),y("Fetching from URL…","info");try{const r=await fetch(o);if(!r.ok)throw new Error("HTTP "+r.status);const c=await r.blob(),a=new File([c],"gtfs.zip",{type:"application/zip"});await we(a,n,{sourceType:"url",sourceUrl:o}),e&&(e.value=""),t&&(t.value="")}catch(r){r.name==="TypeError"||String(r.message).includes("Failed to fetch")?y('Cannot import: CORS restriction. Download and use "From File".',"error"):y("Import failed: "+r.message,"error")}}async function De(){var i,s;const e=document.getElementById("gtfsFileName"),t=document.getElementById("gtfsFile"),o=(i=t==null?void 0:t.files)==null?void 0:i[0];if(!o){y("Please select a GTFS zip file","error");return}const n=((s=e==null?void 0:e.value)==null?void 0:s.trim())||o.name.replace(".zip","");te();try{await we(o,n,{sourceType:"file",filename:o.name}),e&&(e.value=""),t&&(t.value="")}catch(r){y("Import failed: "+r.message,"error")}}async function we(e,t,o){var i,s;const n=document.createElement("div");n.className="import-progress",n.innerHTML='<div class="progress-container"><h3>Importing '+t+'…</h3><div class="progress-bar"><div class="progress-fill" style="width:0%"></div></div><div class="progress-text">Starting…</div></div>',document.body.appendChild(n);try{const r=new Worker(new URL("/gtfs-transit-data-explorer/assets/gtfs-worker--DYXaZWA.js",import.meta.url),{type:"module"}),c=await new Promise((d,u)=>{r.onmessage=g=>{const{type:p,data:m,error:h,step:_,progress:N,total:O}=g.data;if(p==="progress"){const P=n.querySelector(".progress-fill"),C=n.querySelector(".progress-text");P&&(P.style.width=O+"%"),C&&(C.textContent=_+": "+N+"%")}else p==="complete"?(r.terminate(),d(m)):p==="error"&&(r.terminate(),u(new Error(h)))},r.onerror=g=>{r.terminate(),u(g)},r.postMessage({type:"parse",data:{file:e,feedName:t}})}),a=v.addFeed(t,c,{...o,size:e.size,importedAt:new Date().toISOString()});document.body.removeChild(n),await $(),await U(),console.log("[GTFS Import] Rendering routes and stops"),await j(),console.log("[GTFS Import] Fitting map to imported data");const l=v.getFeed(a);if(l&&l.stops&&l.stops.size>0){const d=L.latLngBounds();for(const u of l.stops.values())d.extend([u.stop_lat,u.stop_lon]);d.isValid()&&f.fitBounds(d)}y("Imported "+t+" ("+(((i=c.stats)==null?void 0:i.routeCount)||0)+" routes, "+(((s=c.stats)==null?void 0:s.stopCount)||0)+" stops)","success"),B()}catch(r){throw n.parentElement&&document.body.removeChild(n),r}}async function j(){console.log("[Render] Starting route and stop rendering");const t=v.getAllFeeds().filter(l=>!S.has(l.id));if(t.length===0){console.log("[Render] No visible feeds, clearing map"),H();return}H();let o=null;k.size>0&&(o=Array.from(k));const n=be();console.log("[Render] Agency filter:",k.size,"agencies selected, agencyIds:",o);const i=[];for(const l of t){const d=v.getRoutes({feedId:l.id,agencyIds:o,routeTypes:n.length>0?n:null,date:w});i.push(...d)}console.log("[Render] Total routes across all feeds:",i.length);for(const l of t){const d=v.getRoutes({feedId:l.id,agencyIds:o,routeTypes:n.length>0?n:null,date:w});console.log("[Render] Feed",l.name,":",d.length,"routes"),d.forEach(u=>{const g=v.getRouteDetails(l.id,u.route_id,w);if(g&&g.variants&&g.variants.length>0){const p=g.variants[0];if(p.coordinates&&p.coordinates.length>0){const m=Ae(u,i);L.polyline(p.coordinates,{color:m,weight:4,opacity:.75}).addTo(G).on("click",()=>{window.selectRoute(l.id,u.route_id)})}}})}const s=v.getStops({feedId:null,date:w}).filter(l=>!S.has(l.feedId));console.log("[Render] Rendering",s.length,"stops");const r=new Map,c=new Map;console.log("[Render] Building stop-route mapping for",t.length,"feeds");for(const l of t){const d=v.getRoutes({feedId:l.id,agencyIds:o,routeTypes:n.length>0?n:null,date:w});console.log("[Render] Feed",l.name,"- processing",d.length,"routes for stop mapping"),d.forEach(u=>{const g=v.getRouteDetails(l.id,u.route_id,w);g&&g.variants&&g.variants.forEach(p=>{p.stops&&p.stops.forEach(m=>{const h=`${m.stop_id}_${l.id}`;c.has(h)||c.set(h,new Set),c.get(h).add(u.route_type),r.has(h)||r.set(h,[]),r.get(h).find(_=>_.route_id===u.route_id)||r.get(h).push({route_id:u.route_id,route_short_name:u.route_short_name,route_long_name:u.route_long_name,route_type:u.route_type})})})})}console.log("[Render] Stop-route mapping complete:",r.size,"stops have routes"),s.forEach(l=>{const d=`${l.stop_id}_${l.feedId}`,u=c.get(d),g=r.get(d)||[];let p=3;u&&u.size>0&&(p=Array.from(u)[0]);const m=Te(p,28),h=L.marker([l.stop_lat,l.stop_lon],{icon:m}).addTo(T),_=R(p),N=g.length>0?`<span style="display:inline-block;background:${_.color};color:white;padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;margin-top:6px;">${_.name}</span>`:"",O=g.length>0?`<div style="margin-top:8px;padding-top:8px;border-top:1px solid #E5E7EB;">
                <strong style="font-size:0.8rem;color:#374151;">Routes: ${g.length}</strong>
                <div style="margin-top:4px;display:flex;flex-wrap:wrap;gap:4px;">
                    ${g.slice(0,18).map(D=>`<span style="background:${R(D.route_type).color};color:white;padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;">${D.route_short_name||D.route_id}</span>`).join("")}
                    ${g.length>18?`<span style="color:#6B7280;font-size:0.7rem;">+${g.length-18} more</span>`:""}
                </div>
            </div>`:"",P=l.location_type!==void 0?l.location_type===0?"Stop or platform":l.location_type===1?"Station":"Other":"Stop or platform",C=l.wheelchair_boarding!==void 0?l.wheelchair_boarding===1?"Accessible":l.wheelchair_boarding===2?"Not accessible":"No information":"No information",Z=`
            <div style="min-width:240px;font-family:Inter,sans-serif;">
                <div style="font-size:1rem;font-weight:600;color:#111827;margin-bottom:4px;">${l.stop_name}</div>
                <div style="font-size:0.75rem;color:#6B7280;">Stop ID: ${l.stop_id}</div>
                <div style="font-size:0.75rem;color:#6B7280;">Feed: ${l.feedName||"Unknown"}</div>
                ${N}
                <div style="margin-top:8px;padding-top:8px;border-top:1px solid #E5E7EB;font-size:0.75rem;color:#6B7280;">
                    <div>Location Type: ${P}</div>
                    <div style="margin-top:2px;">Accessibility: ${C}</div>
                </div>
                ${O}
                <div style="margin-top:8px;padding-top:8px;border-top:1px solid #E5E7EB;font-size:0.7rem;color:#9CA3AF;">
                    Lat: ${l.stop_lat.toFixed(6)}, Lon: ${l.stop_lon.toFixed(6)}
                </div>
            </div>
        `;h.bindPopup(Z,{maxWidth:320})});const a=[];for(const l of t){const d=v.getRoutes({feedId:l.id,agencyIds:o,routeTypes:n.length>0?n:null,date:w});a.push(...d)}Qe(a)}async function $e(){var o;const e=document.getElementById("kmlFile"),t=(o=e==null?void 0:e.files)==null?void 0:o[0];if(!t){y("Please select a KML or GeoJSON file","error");return}ve(),console.log("[Polygon Import] Starting import of:",t.name);try{const n=await t.text();let i;t.name.endsWith(".kml")?(console.log("[Polygon Import] Converting KML to GeoJSON"),i=Ue(n)):(console.log("[Polygon Import] Parsing GeoJSON"),i=JSON.parse(n));let s=[];i.type==="FeatureCollection"?s=i.features:i.type==="Feature"?s=[i]:(i.type==="Polygon"||i.type==="MultiPolygon")&&(s=[{type:"Feature",geometry:i,properties:{}}]);const r=s.filter(a=>a.geometry&&(a.geometry.type==="Polygon"||a.geometry.type==="MultiPolygon"));if(!r.length){y("No polygon geometries found","error");return}console.log("[Polygon Import] Found",r.length,"polygon(s)");const c=[];r.forEach((a,l)=>{var p,m,h;const d=((p=a.properties)==null?void 0:p.name)||((m=a.properties)==null?void 0:m.Name)||t.name.replace(/\.[^.]+$/,"")+(r.length>1?" "+(l+1):"");console.log("[Polygon Import] Polygon",l,"name:",d);const u={id:"poly_"+Date.now()+"_"+l,name:d,geometry:a.geometry,properties:{name:d,description:((h=a.properties)==null?void 0:h.description)||""},visible:!0};I.push(u),E.add(u.id);const g=L.geoJSON(a.geometry,{style:{color:"#3498db",weight:2,opacity:.8,fillOpacity:.2}}).addTo(f);g.bindPopup("<strong>"+d+"</strong>"),F.push(g),c.push(g)}),V(),Y(),B(),c.length&&(console.log("[Polygon Import] Fitting map to imported polygons"),f.fitBounds(L.featureGroup(c).getBounds())),y("Imported "+r.length+" polygon(s)","success"),e&&(e.value="")}catch(n){console.error("[Polygon Import] Error:",n),y("Import failed: "+n.message,"error")}}function Ue(e){const t=new DOMParser().parseFromString(e,"text/xml"),o=[];return t.querySelectorAll("Placemark").forEach(n=>{var c;const i=((c=n.querySelector("name"))==null?void 0:c.textContent)||"Unnamed",s=n.querySelector("coordinates");if(!s)return;const r=s.textContent.trim().split(/\s+/).map(a=>{const[l,d]=a.split(",").map(Number);return[l,d]}).filter(a=>!isNaN(a[0])&&!isNaN(a[1]));r.length<3||o.push({type:"Feature",geometry:{type:"Polygon",coordinates:[r]},properties:{name:i}})}),{type:"FeatureCollection",features:o}}async function $(){const e=v.getAllFeeds(),t=document.getElementById("feedFilter");t&&(t.innerHTML='<option value="">All Feeds</option>',e.forEach(s=>{const r=document.createElement("option");r.value=s.id;const c=S.has(s.id)?" (hidden)":"";r.textContent=s.name+c,S.has(s.id)&&(r.style.color="var(--gray-400)"),t.appendChild(r)}));const o=document.getElementById("feedList"),n=document.getElementById("emptyFeeds"),i=document.getElementById("resetDbSection");if(o){if(!e.length){o.innerHTML="",n&&(n.style.display="block"),i&&(i.style.display="none");return}n&&(n.style.display="none"),i&&(i.style.display="block"),o.innerHTML=e.map(s=>{var a,l;const c=!S.has(s.id)?me:he;return`<li class="dock-list-item">
            <div class="dock-list-item-info">
                <div class="dock-list-item-name">${s.name}</div>
                <div class="dock-list-item-detail">${((a=s.stats)==null?void 0:a.routeCount)||0} routes · ${((l=s.stats)==null?void 0:l.stopCount)||0} stops</div>
            </div>
            <button class="dock-list-item-action" data-toggle-feed="${s.id}" title="Toggle visibility">${c}</button>
            <button class="dock-list-item-delete" data-rm-feed="${s.id}" title="Remove">×</button>
        </li>`}).join(""),o.querySelectorAll("[data-toggle-feed]").forEach(s=>{s.addEventListener("click",()=>{const r=parseInt(s.dataset.toggleFeed);console.log("[Feed Visibility] Toggling feed:",r),ze(r)})}),o.querySelectorAll("[data-rm-feed]").forEach(s=>{s.addEventListener("click",()=>Ve(parseInt(s.dataset.rmFeed)))})}}async function Ve(e){const t=v.getFeed(e),o=t?t.name:"this feed";confirm(`Remove ${o}?

This will permanently delete the feed and all its data.`)&&(v.removeFeed(e),S.delete(e),await $(),await U(),await j(),y("Feed removed","success"),B())}async function ze(e){console.log("[Feed Visibility] Toggle called for feed:",e,"Current hidden:",S.has(e)),S.has(e)?(S.delete(e),console.log("[Feed Visibility] Showing feed:",e),await $(),await U(),await j(),y("Feed shown","success")):(S.add(e),console.log("[Feed Visibility] Hiding feed:",e),await $(),await U(),await j(),y("Feed hidden","success")),B()}async function qe(){confirm(`Remove all data?

This will permanently delete all feeds and polygons.`)&&(v.clear(),I=[],F.forEach(e=>f.removeLayer(e)),F=[],E.clear(),k.clear(),S.clear(),H(),await $(),await U(),V(),Y(),y("All data removed","success"),B())}async function U(){var r;const e=parseInt((r=document.getElementById("feedFilter"))==null?void 0:r.value)||null;let t=v.getAgencies?v.getAgencies(e):[];t=t.filter(c=>!S.has(c.feedId)),console.log("[Agency Filter] Raw agencies:",t.length);const o=new Map;t.forEach(c=>{const a=c.agency_name||c.agency_id||"Unknown";o.has(a)||o.set(a,{unified_id:a,agency_name:a,agency_ids:[],feed_ids:[]});const l=o.get(a);c.agency_id&&!l.agency_ids.includes(c.agency_id)&&l.agency_ids.push(c.agency_id),c.feedId&&!l.feed_ids.includes(c.feedId)&&l.feed_ids.push(c.feedId)});const n=Array.from(o.values());console.log("[Agency Filter] Unified agencies:",n.length);const i=document.getElementById("agencyFilterGroup"),s=document.getElementById("agencyToggleList");if(n.length===0){i&&(i.style.display="none");return}i&&(i.style.display="block"),k.size||n.forEach(c=>{c.agency_ids.forEach(a=>k.add(a))}),s&&(s.innerHTML=n.map(c=>{const a=c.agency_ids.every(l=>k.has(l));return`<label class="toggle-item">
                <input type="checkbox" data-unified="${c.unified_id}" data-aids="${c.agency_ids.join(",")}"${a?" checked":""}>
                <span>${c.agency_name}</span>
            </label>`}).join(""),s.querySelectorAll("[data-unified]").forEach(c=>{c.addEventListener("change",()=>{console.log("[Agency Filter] Agency toggled:",c.dataset.unified,c.checked);const a=c.dataset.aids.split(",");c.checked?a.forEach(l=>k.add(l)):a.forEach(l=>k.delete(l)),j(),B()})}))}function Ge(e){document.querySelectorAll("#agencyToggleList [data-unified]").forEach(o=>{o.checked=e;const n=o.dataset.aids.split(",");e?n.forEach(i=>k.add(i)):n.forEach(i=>k.delete(i))}),j()}function He(e){document.querySelectorAll('#routeToggleList input[type="checkbox"]').forEach(t=>t.checked=e),J()}function Je(e){e?I.forEach(t=>E.add(t.id)):E.clear(),document.querySelectorAll('#polygonToggleList input[type="checkbox"]').forEach(t=>t.checked=e),oe()}function Ze(e){T&&(e?f.hasLayer(T)||f.addLayer(T):f.hasLayer(T)&&f.removeLayer(T))}function Y(){const e=document.getElementById("polygonLayerSection"),t=document.getElementById("polygonToggleList");if(!I.length){e&&(e.style.display="none");return}e&&(e.style.display="block"),t&&(t.innerHTML=I.map(o=>'<label class="toggle-item"><input type="checkbox" data-ptog="'+o.id+'"'+(E.has(o.id)?" checked":"")+"><span>"+o.name+"</span></label>").join(""),t.querySelectorAll("[data-ptog]").forEach(o=>{o.addEventListener("change",()=>{o.checked?E.add(o.dataset.ptog):E.delete(o.dataset.ptog),oe()})}))}function oe(){console.log("[Polygon Visibility] Rendering polygon visibility"),I.forEach((e,t)=>{const o=F[t];o&&(E.has(e.id)?f.hasLayer(o)||(console.log("[Polygon Visibility] Showing polygon:",e.name),f.addLayer(o)):(console.log("[Polygon Visibility] Hiding polygon:",e.name),f.removeLayer(o)))})}function We(){const e=document.getElementById("dayTypeSelect"),t=document.getElementById("calTriggerWrap");(e==null?void 0:e.value)==="specific"?t&&(t.style.display="block"):t&&(t.style.display="none"),J()}function Ye(e){e.stopPropagation();const t=document.getElementById("calPopup");if(!t)return;if(t.style.display==="block"){t.style.display="none";return}t.style.display="block",t.innerHTML='<input type="date" id="calDatePicker" style="padding:0.5rem;border:1px solid var(--gray-300);border-radius:var(--radius);font-family:inherit;">';const o=document.getElementById("calDatePicker");o&&w&&(o.value=w.substring(0,4)+"-"+w.substring(4,6)+"-"+w.substring(6,8)),o==null||o.addEventListener("change",()=>{if(o.value){w=o.value.replace(/-/g,"");const n=document.getElementById("calTriggerText");n&&(n.textContent=o.value),t.style.display="none",J()}})}function ne(e){return""+e.getFullYear()+String(e.getMonth()+1).padStart(2,"0")+String(e.getDate()).padStart(2,"0")}async function J(){console.log("[Filters] Apply filters called"),await j()}function Ke(){const e=document.getElementById("feedFilter");e&&(e.value="");const t=document.getElementById("dayTypeSelect");t&&(t.value="all");const o=document.getElementById("calTriggerWrap");o&&(o.style.display="none"),w=ne(new Date),J(),y("Filters cleared","info")}function be(){const e=[];for(let t=0;t<=7;t++){const o=document.getElementById("routeType"+t);o!=null&&o.checked&&e.push(t)}return e}function Qe(e){const t=document.getElementById("routeLayerSection"),o=document.getElementById("routeToggleList");if(!(e!=null&&e.length)){t&&(t.style.display="none");return}t&&(t.style.display="block"),o&&(o.innerHTML=e.slice(0,50).map(n=>'<label class="toggle-item" style="cursor:pointer"><span style="color:'+R(n.route_type).color+';font-weight:600">'+(n.route_short_name||n.route_id)+"</span></label>").join(""))}async function Xe(e,t=!0){var n,i,s;if(H(),!((n=e.variants)!=null&&n.length)){y("No variants on selected date","warning");return}const o=e.variants[0];if((i=o.coordinates)!=null&&i.length){const r=R(e.route_type),c=L.polyline(o.coordinates,{color:r.color,weight:4,opacity:.7}).addTo(G);t&&(console.log("[Route Display] Fitting bounds to route"),f.fitBounds(c.getBounds()))}o.stops&&o.stops.forEach(r=>{L.circleMarker([r.stop_lat,r.stop_lon],{radius:6,fillColor:R(e.route_type).color,color:"#fff",weight:2,opacity:1,fillOpacity:.8}).addTo(T).bindPopup("<strong>"+r.stop_name+"</strong>"+(r.stop_code?"<br>Code: "+r.stop_code:""))}),y("Showing "+(e.route_short_name||e.route_long_name)+" ("+(((s=o.stops)==null?void 0:s.length)||0)+" stops)","success")}function H(){T&&T.clearLayers(),G&&G.clearLayers()}function V(){const e=document.getElementById("polygonList"),t=document.getElementById("emptyPolygons");if(e){if(!I.length){e.innerHTML="",t&&(t.style.display="block"),Y();return}t&&(t.style.display="none"),e.innerHTML=I.map(o=>'<li class="dock-list-item"><div class="dock-list-item-info"><div class="dock-list-item-name">'+o.name+'</div></div><button class="dock-list-item-action" data-ptogvis="'+o.id+'" title="Toggle">'+(E.has(o.id)?me:he)+'</button><button class="dock-list-item-delete" data-prm="'+o.id+'" title="Remove">×</button></li>').join(""),e.querySelectorAll("[data-ptogvis]").forEach(o=>{o.addEventListener("click",()=>{const n=o.dataset.ptogvis;E.has(n)?E.delete(n):E.add(n),V(),oe(),B()})}),e.querySelectorAll("[data-prm]").forEach(o=>{o.addEventListener("click",()=>et(o.dataset.prm))}),Y()}}function et(e){const t=I.find(i=>i.id===e),o=t?t.name:"this polygon";if(!confirm(`Remove ${o}?`))return;const n=I.findIndex(i=>i.id===e);n!==-1&&(I.splice(n,1),F[n]&&(f.removeLayer(F[n]),F.splice(n,1)),E.delete(e),V(),y("Polygon removed","success"),B())}function tt(){b.isDirty&&!confirm("Discard unsaved changes?")||(v.clear(),I=[],F.forEach(e=>f.removeLayer(e)),F=[],E.clear(),k.clear(),S.clear(),w=ne(new Date),H(),b={projectName:"Untitled Project",isDirty:!1,savedFilePath:null,createdAt:new Date().toISOString()},z(),$(),U(),V(),y("New project created","success"))}async function xe(){var n;const e={selectedDate:w,selectedFeedId:((n=document.getElementById("feedFilter"))==null?void 0:n.value)||null,visibleAgencyIds:Array.from(k),routeTypes:be()},t=Le(b.projectName,f,I,v.getAllFeeds(),e),o=await Se(t,b.projectName+".tde");o.success&&!o.cancelled&&(rt(),y("Project saved","success"))}async function ot(){const e=prompt("Project name:",b.projectName);e&&(b.projectName=e,b.createdAt||(b.createdAt=new Date().toISOString()),await xe(),z())}async function nt(){var t,o;const e=document.getElementById("projectFileInput");if((t=e==null?void 0:e.files)!=null&&t.length)try{const n=await Fe(e.files[0]);n.mapState&&f.setView([n.mapState.center.lat,n.mapState.center.lng],n.mapState.zoom),I=n.polygons||[],E.clear(),I.forEach(i=>E.add(i.id)),it(),V(),n.filters&&(w=n.filters.selectedDate,n.filters.visibleAgencyIds&&(k=new Set(n.filters.visibleAgencyIds))),b.projectName=n.projectName,b.createdAt=n.createdAt,b.isDirty=!1,z(),(o=n.feeds)!=null&&o.length&&st(n.feeds),y("Project loaded","success"),e.value=""}catch(n){console.error(n),y("Load failed: "+n.message,"error")}}function it(){F.forEach(e=>f.removeLayer(e)),F=[],I.forEach(e=>{const t=L.geoJSON(e.geometry,{style:{color:"#3498db",weight:2,opacity:.8,fillOpacity:.2}}).addTo(f);t.bindPopup("<strong>"+e.name+"</strong>"),F.push(t)})}function st(e){const t=document.createElement("div");t.style.cssText="position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:9999;max-width:600px;padding:1.5rem;background:#FFF3CD;border:2px solid #FFC107;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);",t.innerHTML='<h3 style="margin:0 0 .5rem;color:#856404">⚠️ GTFS Data Not Included</h3><p style="color:#856404">Requires '+e.length+' feed(s):</p><ul style="padding-left:1.5rem">'+e.map(o=>'<li style="color:#856404">'+o.name+(o.sourceUrl?' <a href="'+o.sourceUrl+'" target="_blank">(Download)</a>':"")+"</li>").join("")+'</ul><button style="margin-top:.75rem;padding:.4rem 1rem;border:1px solid #856404;background:transparent;border-radius:4px;cursor:pointer;color:#856404">Got it</button>',document.body.appendChild(t),t.querySelector("button").addEventListener("click",()=>t.remove())}function B(){b.isDirty=!0,z();const e=document.getElementById("burgerIndicator");e&&(e.style.display="block",e.className="burger-indicator dirty")}function rt(){b.isDirty=!1,z();const e=document.getElementById("burgerIndicator");e&&(e.style.display="none")}function z(){const e=document.getElementById("projectNameDisplay");e&&(b.projectName&&b.projectName!=="Untitled Project"?(e.textContent=b.projectName+(b.isDirty?" •":""),e.style.display="inline"):e.style.display="none")}function y(e,t){t=t||"info";const o=document.getElementById("toast");if(o){const i=o.querySelector(".toast-message"),s=o.querySelector(".toast-icon");i&&(i.textContent=e),s&&(s.textContent=t==="error"?"✗":t==="warning"?"⚠":"✓"),o.className="toast toast-"+t+" show",clearTimeout(o._ht),o._ht=setTimeout(()=>o.classList.remove("show"),3e3);return}const n=document.createElement("div");n.className="toast toast-"+t,n.textContent=e,document.body.appendChild(n),setTimeout(()=>n.classList.add("show"),10),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>{var i;return(i=n.parentElement)==null?void 0:i.removeChild(n)},300)},3e3)}window.selectRoute=async function(e,t){const o=v.getRouteDetails?v.getRouteDetails(e,t,w):null;if(!o){y("Route not found","error");return}await Xe(o)};window.dataManager=v;window.projectState=b;console.log("Transit Data Explorer v"+q+" ready.");
